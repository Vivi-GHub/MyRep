<html>

<head>
  <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
  <form id="film-form">
    <label for="title">Название:</label><br />
    <input type="text" id="title" name="title" /><br />
    <label for="genre">Жанр:</label><br />
    <input type="text" id="genre" name="genre" /><br />
    <label for="releaseYear">Год:</label><br />
    <input type="text" id="releaseYear" name="releaseYear" /><br />
    <input type="checkbox" id="isWatched" name="isWatched" />
    <label for="isWatched">Успели посмотреть?</label><br />


    <button type="submit">Добавить</button>
  </form>
  <select id="sort">
    <option value="title">Название</option>
    <option value="genre">Жанр</option>
    <option value="releaseYear">Год</option>
  </select>
  <button class="sortBtn" type="button">Сортировать</button>
  <table id="film-table">
    <thead>
      <tr>
        <th>Название</th>
        <th>Жанр</th>
        <th>Год</th>
        <th>Успели посмотреть?</th>
        <th>Действие</th>
      </tr>
    </thead>
    <tbody id="film-tbody">

    </tbody>
  </table>
  <script>

    function handleFormSubmit(e) {
      e.preventDefault()

      const form = document.querySelector('#film-form')

      if (!validateInputs()) {
        form.reportValidity()
        return
      }

      const title = document.querySelector('#title').value;
      const genre = document.querySelector('#genre').value;
      const releaseYear = document.querySelector('#releaseYear').value;
      const isWatched = document.querySelector('#isWatched').checked;

      const film = {
        title,
        genre,
        releaseYear,
        isWatched,
      }

      addFilmToLocalStorage(film)
      form.reset()
    }

    function addFilmToLocalStorage(film) {
      const films = JSON.parse(localStorage.getItem('films')) || []
      films.push(film)
      localStorage.setItem('films', JSON.stringify(films))

      renderTable()
    }

    function renderTable() {
      const films = JSON.parse(localStorage.getItem('films')) || []
      const filmTableBody = document.querySelector('#film-tbody');
      filmTableBody.innerHTML = ""

      films.forEach((film, index) => {
        const row = document.createElement('tr')

        row.innerHTML = `
        <td>${film.title}</td>
        <td>${film.genre}</td>
        <td>${film.releaseYear}</td>
        <td>${film.isWatched ? "Да" : "Нет"}</td>
        <td>
          <button data-index="${index}" class="delete-btn">Удалить</button>
          <button data-index="${index}" class="edit-btn">Редактировать</button>
        </td> 
      `

        const deleteBtn = row.querySelector('.delete-btn')

        deleteBtn.addEventListener('click', () => {
          removeFilm(index)
        })

        const editBtn = row.querySelector('.edit-btn')
        editBtn.addEventListener('click', () => {
          editFilm(index)
        })

        filmTableBody.appendChild(row)
      })
    }

    function removeFilm(index) {
      const films = JSON.parse(localStorage.getItem('films')) || []
      films.splice(index, 1);
      localStorage.setItem('films', JSON.stringify(films));
      renderTable();
    }

    function editFilm(index) {
      const films = JSON.parse(localStorage.getItem('films')) || [];
      const film = films[index];

      document.querySelector('#title').value = film.title;
      document.querySelector('#genre').value = film.genre;
      document.querySelector('#releaseYear').value = film.releaseYear;
      document.querySelector('#isWatched').checked = film.isWatched;

      films.splice(index, 1);
      localStorage.setItem('films', JSON.stringify(films));
    }

    const sortBtn = document.querySelector('.sortBtn')

    sortBtn.addEventListener('click', () => {
      const selectEl = document.querySelector('#sort').value;

      const films = JSON.parse(localStorage.getItem('films')) || []

      films.sort((a, b) => {
        if (selectEl === 'releaseYear') {
          return a[selectEl] - b[selectEl]
        } else {
          return a[selectEl].localeCompare(b[selectEl]);
        }
      })

      localStorage.setItem('films', JSON.stringify(films));

      renderTable()
    })

    const title = document.querySelector('#title');
    const genre = document.querySelector('#genre');
    const releaseYear = document.querySelector('#releaseYear');

    title.addEventListener('input', function () {
      title.setCustomValidity('')
    })

    genre.addEventListener('input', function () {
      genre.setCustomValidity('')
    })

    releaseYear.addEventListener('input', function () {
      releaseYear.setCustomValidity('')
    })

    function validateInputs() {
      let valid = true

      if (title.value == '') {
        title.setCustomValidity('Заполните это поле')
        valid = false
      }

      if (genre.value == '') {
        genre.setCustomValidity('Заполните это поле')
        valid = false
      }

      if (releaseYear.value == '') {
        releaseYear.setCustomValidity('Заполните это поле')
        valid = false
      }

      return valid
    }

    document.querySelector('#film-form').addEventListener('submit', handleFormSubmit)
    renderTable()
  </script>
</body>

</html>